from typing import Dict

import requests
from requests_toolbelt import MultipartEncoder
from baseopensdk.core import JSON, logger
from baseopensdk.core.model import *
from baseopensdk.core.const import *
from baseopensdk.core.enum import *


class Transport(object):

    @staticmethod
    def execute(conf: Config, req: BaseRequest, option: Optional[RequestOption] = None) -> RawResponse:
        if option is None:
            option = RequestOption()
            
        # 拼接url
        url: str = _build_url(conf.domain, req.uri, req.paths, conf.app_token)

        # 组装header
        headers: Dict[str, str] = _build_header(req, option, conf.personal_base_token)

        data = req.body
        if not isinstance(req.body, MultipartEncoder):
            data = JSON.marshal(req.body).encode(UTF_8) if req.body is not None else None

        response = requests.request(
            str(req.http_method.name),
            url,
            headers=headers,
            params=req.queries,
            data=data,
            timeout=conf.timeout,
        )

        logger.debug(f"{str(req.http_method.name)} {url} {response.status_code}, "
                     f"headers: {JSON.marshal(headers)}, "
                     f"params: {JSON.marshal(req.queries)}, "
                     f"body: {data}")

        resp = RawResponse()
        resp.status_code = response.status_code
        resp.header = dict(response.headers)
        resp.content = response.content

        return resp


def _build_url(domain: str, uri: str, paths: Dict[str, str], app_token: str) -> str:
    # 帮用户注入 Base 业务共用的 app_token，降低接口调用成本
    paths['app_token'] = app_token

    if paths is None:
        paths = {}
    for key in paths:
        uri = uri.replace(":" + key, paths[key])

    return domain + uri


def _build_header(request: BaseRequest, option: RequestOption, personal_base_token: str) -> Dict[str, str]:
    headers = request.headers

    # 添加ua
    headers[USER_AGENT] = f"{PROJECT}/{VERSION}"

    # 附加header
    if option.headers is not None:
        for key in option.headers:
            headers[key] = option.headers[key]

    # 添加token
    headers[AUTHORIZATION] = f"Bearer {personal_base_token}"

    return headers
